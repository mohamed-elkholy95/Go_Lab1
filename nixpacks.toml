# Nixpacks Configuration for Pythoughts Platform
# Optimized for Dokploy deployment with Astro and Node.js

# ============================================================================
# PROVIDERS
# ============================================================================
providers = ["node"]

# ============================================================================
# PHASES - Build Process Configuration
# ============================================================================

# ----------------------------------------------------------------------------
# SETUP PHASE - Install system dependencies
# ----------------------------------------------------------------------------
[phases.setup]
nixPkgs = [
  "nodejs_20",      # Node.js 20 LTS
  "npm",            # NPM package manager
  "python3",        # Python for node-gyp
  "gcc",            # C compiler for native modules
  "gnumake"         # Make for build tools
]

# ----------------------------------------------------------------------------
# INSTALL PHASE - Install Node.js dependencies
# ----------------------------------------------------------------------------
[phases.install]
dependsOn = ["setup"]
cmds = [
  "npm ci --legacy-peer-deps --prefer-offline --no-audit"
]

# ----------------------------------------------------------------------------
# BUILD PHASE - Build the application
# ----------------------------------------------------------------------------
[phases.build]
dependsOn = ["install"]
cmds = [
  # Type checking
  "npx astro check",

  # Build the application
  "npm run build",

  # Verify build output exists
  "ls -la dist/"
]

# ----------------------------------------------------------------------------
# START PHASE - Run the application
# ----------------------------------------------------------------------------
[start]
cmd = "node dist/server/entry.mjs"

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
[variables]
# Node environment
NODE_ENV = "production"
NODE_VERSION = "20"

# Server configuration
HOST = "0.0.0.0"
PORT = "3000"

# Astro configuration
PUBLIC_SITE_NAME = "Pythoughts"
ASTRO_TELEMETRY_DISABLED = "1"

# NPM configuration
NPM_CONFIG_LOGLEVEL = "error"
