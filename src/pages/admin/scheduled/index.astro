---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { getScheduledPosts } from '@/lib/services/scheduler';

export const prerender = false;

// Fetch scheduled posts
const { posts: scheduledPosts } = await getScheduledPosts();

function formatDateTime(date: Date | string | null): string {
  if (!date) return 'Not scheduled';
  return new Date(date).toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

function getTimeUntil(scheduledAt: Date | string | null): string {
  if (!scheduledAt) return '';

  const now = new Date();
  const scheduled = new Date(scheduledAt);
  const diff = scheduled.getTime() - now.getTime();

  if (diff < 0) return 'Overdue';

  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  if (days > 0) return `in ${days}d ${hours}h`;
  if (hours > 0) return `in ${hours}h ${minutes}m`;
  return `in ${minutes}m`;
}
---

<AdminLayout title="Scheduled Posts" description="Manage scheduled posts">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-bold mb-2">‚è∞ Scheduled Posts</h1>
        <p class="text-slate-600 dark:text-slate-400">
          Posts scheduled for automatic publication
        </p>
      </div>
      <div class="flex gap-3">
        <button
          id="runSchedulerBtn"
          class="btn btn-secondary"
          title="Manually trigger scheduler to publish due posts"
        >
          ‚ñ∂Ô∏è Run Scheduler Now
        </button>
        <a href="/admin/posts/new" class="btn btn-primary">
          + New Post
        </a>
      </div>
    </div>

    <!-- Info Banner -->
    <div class="card bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 mb-6">
      <div class="flex items-start gap-3">
        <div class="text-2xl">‚ÑπÔ∏è</div>
        <div class="flex-1">
          <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-1">
            How Scheduled Publishing Works
          </h3>
          <p class="text-sm text-blue-800 dark:text-blue-200">
            Posts are automatically published when their scheduled time arrives. The scheduler runs every 5 minutes via cron job.
            You can also manually trigger the scheduler using the "Run Scheduler Now" button above.
          </p>
        </div>
      </div>
    </div>

    <!-- Scheduled Posts List -->
    {scheduledPosts.length === 0 ? (
      <div class="card text-center py-12">
        <div class="text-6xl mb-4">üìÖ</div>
        <h2 class="text-2xl font-bold mb-2">No Scheduled Posts</h2>
        <p class="text-slate-600 dark:text-slate-400 mb-6">
          Schedule posts to be automatically published at a future date
        </p>
        <a href="/admin/posts/new" class="btn btn-primary inline-block">
          Create Your First Scheduled Post
        </a>
      </div>
    ) : (
      <div class="space-y-4">
        {scheduledPosts.map((post) => (
          <div class="card hover:shadow-lg transition-shadow">
            <div class="flex items-start gap-4">
              <!-- Status Indicator -->
              <div class="flex-shrink-0 pt-1">
                <div class="w-12 h-12 rounded-full bg-orange-100 dark:bg-orange-900 flex items-center justify-center">
                  <span class="text-2xl">‚è∞</span>
                </div>
              </div>

              <!-- Post Info -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-4 mb-2">
                  <div class="flex-1 min-w-0">
                    <h3 class="text-xl font-bold mb-1 truncate">
                      {post.title}
                    </h3>
                    {post.excerpt && (
                      <p class="text-slate-600 dark:text-slate-400 text-sm line-clamp-2">
                        {post.excerpt}
                      </p>
                    )}
                  </div>

                  <!-- Time Badge -->
                  <div class="flex-shrink-0">
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300">
                      {getTimeUntil(post.scheduledAt)}
                    </span>
                  </div>
                </div>

                <div class="flex items-center gap-6 text-sm text-slate-600 dark:text-slate-400 mb-3">
                  <div class="flex items-center gap-2">
                    <span>üìÖ</span>
                    <span>
                      <strong>Scheduled:</strong> {formatDateTime(post.scheduledAt)}
                    </span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span>üìù</span>
                    <span>
                      <strong>Created:</strong> {formatDateTime(post.createdAt)}
                    </span>
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                  <a
                    href={`/admin/posts/${post.id}/edit`}
                    class="btn btn-sm btn-secondary"
                  >
                    ‚úèÔ∏è Edit
                  </a>
                  <a
                    href={`/posts/${post.slug}`}
                    target="_blank"
                    class="btn btn-sm btn-outline"
                  >
                    üëÅÔ∏è Preview
                  </a>
                  <button
                    class="btn btn-sm btn-outline cancel-schedule-btn"
                    data-post-id={post.id}
                    data-post-title={post.title}
                  >
                    ‚ùå Cancel Schedule
                  </button>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
</AdminLayout>

<script>
  // Run scheduler manually
  const runSchedulerBtn = document.getElementById('runSchedulerBtn');
  if (runSchedulerBtn) {
    runSchedulerBtn.addEventListener('click', async () => {
      if (!confirm('Run the scheduler now to publish all due posts?')) return;

      runSchedulerBtn.textContent = '‚è≥ Running...';
      runSchedulerBtn.setAttribute('disabled', 'true');

      try {
        const response = await fetch('/api/scheduler/publish', {
          method: 'GET',
        });

        const result = await response.json();

        if (result.success) {
          alert(
            `‚úÖ Success! Published ${result.publishedCount} post(s).\n\n` +
            (result.publishedPosts?.length > 0
              ? 'Published:\n' + result.publishedPosts.map((p: any) => `- ${p.title}`).join('\n')
              : 'No posts were due for publishing.')
          );
          window.location.reload();
        } else {
          alert(`‚ùå Error: ${result.error || 'Failed to run scheduler'}`);
        }
      } catch (error) {
        console.error('Scheduler error:', error);
        alert('‚ùå Error running scheduler. Check console for details.');
      } finally {
        runSchedulerBtn.textContent = '‚ñ∂Ô∏è Run Scheduler Now';
        runSchedulerBtn.removeAttribute('disabled');
      }
    });
  }

  // Cancel schedule
  const cancelButtons = document.querySelectorAll('.cancel-schedule-btn');
  cancelButtons.forEach((btn) => {
    btn.addEventListener('click', async () => {
      const postId = btn.getAttribute('data-post-id');
      const postTitle = btn.getAttribute('data-post-title');

      if (!confirm(`Cancel scheduled publishing for "${postTitle}"?`)) return;

      try {
        const response = await fetch(`/api/posts/${postId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheduledAt: null,
          }),
        });

        if (response.ok) {
          alert('‚úÖ Schedule cancelled successfully');
          window.location.reload();
        } else {
          const result = await response.json();
          alert(`‚ùå Error: ${result.error || 'Failed to cancel schedule'}`);
        }
      } catch (error) {
        console.error('Error canceling schedule:', error);
        alert('‚ùå Error canceling schedule. Check console for details.');
      }
    });
  });
</script>
