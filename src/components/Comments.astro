---
interface Comment {
  id: string;
  content: string;
  createdAt: Date;
  updatedAt: Date;
  user: {
    id: string;
    name: string | null;
    username: string;
    avatarUrl: string | null;
  };
  replies: Comment[];
}

interface Props {
  postId: string;
  currentUser?: {
    id: string;
    role: string;
  } | null;
}

const { postId, currentUser } = Astro.props;

// Fetch comments for this post
async function fetchComments() {
  try {
    const response = await fetch(`${import.meta.env.SITE_URL || 'http://localhost:4321'}/api/comments?postId=${postId}&status=approved&limit=100`);
    if (!response.ok) {
      console.error('Failed to fetch comments');
      return [];
    }
    const data = await response.json();
    return data.comments || [];
  } catch (error) {
    console.error('Error fetching comments:', error);
    return [];
  }
}

const commentsData = await fetchComments();
const comments = commentsData.map((item: any) => ({
  ...item.comment,
  user: item.user,
}));

// Build nested structure
function buildCommentTree(comments: any[]) {
  const commentMap = new Map();
  const rootComments: Comment[] = [];

  // First pass: create map
  comments.forEach((comment) => {
    commentMap.set(comment.id, { ...comment, replies: [] });
  });

  // Second pass: build tree
  comments.forEach((comment) => {
    const commentNode = commentMap.get(comment.id);
    if (comment.parentId) {
      const parent = commentMap.get(comment.parentId);
      if (parent) {
        parent.replies.push(commentNode);
      }
    } else {
      rootComments.push(commentNode);
    }
  });

  return rootComments;
}

const nestedComments = buildCommentTree(comments);

function formatDate(date: Date | string) {
  const d = new Date(date);
  const now = new Date();
  const diff = now.getTime() - d.getTime();
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;

  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
---

<div class="comments-section" id="comments">
  <h2 class="text-2xl font-bold mb-6">
    Comments ({comments.length})
  </h2>

  {currentUser ? (
    <div id="comment-form-container" class="mb-8">
      <form id="new-comment-form" class="comment-form">
        <input type="hidden" name="postId" value={postId} />
        <textarea
          name="content"
          placeholder="Write a comment..."
          rows="3"
          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-800 dark:text-white resize-y"
          required
        ></textarea>
        <div class="flex justify-end gap-2 mt-2">
          <button
            type="submit"
            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
          >
            Post Comment
          </button>
        </div>
      </form>
    </div>
  ) : (
    <div class="mb-8 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg text-center">
      <p class="text-gray-600 dark:text-gray-400">
        <a href="/auth/login" class="text-purple-600 hover:underline">Log in</a> to post a comment
      </p>
    </div>
  )}

  <div class="comments-list space-y-6">
    {nestedComments.length === 0 ? (
      <p class="text-gray-500 dark:text-gray-400 text-center py-8">
        No comments yet. Be the first to comment!
      </p>
    ) : (
      nestedComments.map((comment) => (
        <div class="comment" data-comment-id={comment.id}>
          <div class="flex gap-3">
            <div class="flex-shrink-0">
              {comment.user.avatarUrl ? (
                <img
                  src={comment.user.avatarUrl}
                  alt={comment.user.name || comment.user.username}
                  class="w-10 h-10 rounded-full"
                />
              ) : (
                <div class="w-10 h-10 rounded-full bg-purple-600 text-white flex items-center justify-center font-semibold">
                  {(comment.user.name || comment.user.username)[0].toUpperCase()}
                </div>
              )}
            </div>
            <div class="flex-1">
              <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <a href={`/users/${comment.user.username}`} class="font-semibold hover:underline">
                    {comment.user.name || comment.user.username}
                  </a>
                  <span class="text-sm text-gray-500 dark:text-gray-400">
                    {formatDate(comment.createdAt)}
                  </span>
                </div>
                <div class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                  {comment.content}
                </div>
              </div>
              <div class="flex items-center gap-4 mt-2 text-sm">
                {currentUser && (
                  <button
                    class="reply-btn text-purple-600 hover:underline"
                    data-comment-id={comment.id}
                  >
                    Reply
                  </button>
                )}
                {currentUser && (currentUser.id === comment.user.id || currentUser.role === 'admin') && (
                  <>
                    <button
                      class="edit-btn text-gray-600 dark:text-gray-400 hover:underline"
                      data-comment-id={comment.id}
                    >
                      Edit
                    </button>
                    <button
                      class="delete-btn text-red-600 hover:underline"
                      data-comment-id={comment.id}
                    >
                      Delete
                    </button>
                  </>
                )}
              </div>

              <!-- Reply form placeholder -->
              <div id={`reply-form-${comment.id}`} class="reply-form-container mt-3 hidden"></div>

              <!-- Nested replies -->
              {comment.replies.length > 0 && (
                <div class="replies mt-4 ml-4 border-l-2 border-gray-200 dark:border-gray-700 pl-4 space-y-4">
                  {comment.replies.map((reply) => (
                    <div class="comment" data-comment-id={reply.id}>
                      <div class="flex gap-3">
                        <div class="flex-shrink-0">
                          {reply.user.avatarUrl ? (
                            <img
                              src={reply.user.avatarUrl}
                              alt={reply.user.name || reply.user.username}
                              class="w-8 h-8 rounded-full"
                            />
                          ) : (
                            <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm font-semibold">
                              {(reply.user.name || reply.user.username)[0].toUpperCase()}
                            </div>
                          )}
                        </div>
                        <div class="flex-1">
                          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-1">
                              <a href={`/users/${reply.user.username}`} class="font-semibold text-sm hover:underline">
                                {reply.user.name || reply.user.username}
                              </a>
                              <span class="text-xs text-gray-500 dark:text-gray-400">
                                {formatDate(reply.createdAt)}
                              </span>
                            </div>
                            <div class="text-gray-700 dark:text-gray-300 text-sm whitespace-pre-wrap">
                              {reply.content}
                            </div>
                          </div>
                          <div class="flex items-center gap-4 mt-1 text-xs">
                            {currentUser && (currentUser.id === reply.user.id || currentUser.role === 'admin') && (
                              <>
                                <button
                                  class="edit-btn text-gray-600 dark:text-gray-400 hover:underline"
                                  data-comment-id={reply.id}
                                >
                                  Edit
                                </button>
                                <button
                                  class="delete-btn text-red-600 hover:underline"
                                  data-comment-id={reply.id}
                                >
                                  Delete
                                </button>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      ))
    )}
  </div>
</div>

<script>
  // Handle new comment submission
  const newCommentForm = document.getElementById('new-comment-form') as HTMLFormElement;
  if (newCommentForm) {
    newCommentForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(newCommentForm);
      const content = formData.get('content') as string;
      const postId = formData.get('postId') as string;

      try {
        const response = await fetch('/api/comments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ postId, content }),
        });

        if (response.ok) {
          // Reload page to show new comment
          window.location.reload();
        } else {
          const error = await response.json();
          alert(error.message || 'Failed to post comment');
        }
      } catch (error) {
        console.error('Error posting comment:', error);
        alert('Failed to post comment');
      }
    });
  }

  // Handle reply buttons
  document.querySelectorAll('.reply-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      const commentId = (e.target as HTMLElement).dataset.commentId;
      const replyContainer = document.getElementById(`reply-form-${commentId}`);

      if (replyContainer) {
        // Toggle visibility
        if (replyContainer.classList.contains('hidden')) {
          // Hide all other reply forms
          document.querySelectorAll('.reply-form-container').forEach((el) => {
            el.classList.add('hidden');
          });

          // Show this reply form
          replyContainer.classList.remove('hidden');
          replyContainer.innerHTML = `
            <form class="reply-form">
              <textarea
                name="content"
                placeholder="Write a reply..."
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-800 dark:text-white resize-y text-sm"
                required
              ></textarea>
              <div class="flex justify-end gap-2 mt-2">
                <button
                  type="button"
                  class="cancel-reply px-4 py-1 text-sm text-gray-600 dark:text-gray-400 hover:underline"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="px-4 py-1 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                >
                  Reply
                </button>
              </div>
            </form>
          `;

          // Handle reply form submission
          const replyForm = replyContainer.querySelector('form') as HTMLFormElement;
          replyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = (replyForm.querySelector('textarea') as HTMLTextAreaElement).value;
            const postId = (newCommentForm?.querySelector('input[name="postId"]') as HTMLInputElement)?.value;

            try {
              const response = await fetch('/api/comments', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ postId, content, parentId: commentId }),
              });

              if (response.ok) {
                window.location.reload();
              } else {
                const error = await response.json();
                alert(error.message || 'Failed to post reply');
              }
            } catch (error) {
              console.error('Error posting reply:', error);
              alert('Failed to post reply');
            }
          });

          // Handle cancel button
          replyContainer.querySelector('.cancel-reply')?.addEventListener('click', () => {
            replyContainer.classList.add('hidden');
          });
        } else {
          replyContainer.classList.add('hidden');
        }
      }
    });
  });

  // Handle delete buttons
  document.querySelectorAll('.delete-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const commentId = (e.target as HTMLElement).dataset.commentId;

      if (confirm('Are you sure you want to delete this comment?')) {
        try {
          const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            window.location.reload();
          } else {
            const error = await response.json();
            alert(error.message || 'Failed to delete comment');
          }
        } catch (error) {
          console.error('Error deleting comment:', error);
          alert('Failed to delete comment');
        }
      }
    });
  });

  // Handle edit buttons (simplified - just show prompt for now)
  document.querySelectorAll('.edit-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const commentId = (e.target as HTMLElement).dataset.commentId;
      const commentEl = document.querySelector(`[data-comment-id="${commentId}"]`);
      const contentEl = commentEl?.querySelector('.whitespace-pre-wrap');
      const currentContent = contentEl?.textContent?.trim();

      const newContent = prompt('Edit your comment:', currentContent);

      if (newContent && newContent !== currentContent) {
        try {
          const response = await fetch(`/api/comments/${commentId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: newContent }),
          });

          if (response.ok) {
            window.location.reload();
          } else {
            const error = await response.json();
            alert(error.message || 'Failed to update comment');
          }
        } catch (error) {
          console.error('Error updating comment:', error);
          alert('Failed to update comment');
        }
      }
    });
  });
</script>
